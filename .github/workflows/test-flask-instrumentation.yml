name: Test Flask Instrumentation with SigNoz

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Manual trigger option

jobs:
  test-flask-instrumentation:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout the repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install Flask and OpenTelemetry dependencies
        run: |
          pip install Flask opentelemetry-distro==0.43b0 opentelemetry-exporter-otlp==1.22.0
          opentelemetry-bootstrap --action=install

      - name: Start Flask App and Background Instrumentation
        run: |
          export OTEL_RESOURCE_ATTRIBUTES="service.name=flask-app"
          export OTEL_EXPORTER_OTLP_ENDPOINT="https://ingest.us.signoz.cloud:443"
          export OTEL_EXPORTER_OTLP_HEADERS="signoz-access-token=${{ secrets.SIGNOZ_ACCESS_TOKEN }}"
          export OTEL_EXPORTER_OTLP_PROTOCOL="grpc"
          export OTEL_TRACES_EXPORTER="otlp,console"  # Enable both SigNoz and console exporters
          opentelemetry-instrument python3 main.py &
          sleep 5

      - name: Interact with the Flask App (Trigger Traces)
        run: |
          curl http://127.0.0.1:5000/  # Trigger the application to send traces
          sleep 10  # Allow time for traces to be sent

      - name: Verify Traces in the Console
        run: |
          echo "Check console for trace logs..."
